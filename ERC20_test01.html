<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="CACHE-CONTROL" content="NO-CACHE">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.2.3/milligram.min.css">
  <title>ERC20 Token management Test</title>
  <style>
    body {margin-left:50px;}
    #name {font-size:100%; margin-right:5px;}
    #newContAddr {width: 400px; margin-right:5px;}
    #toAccount {width: 400px; margin-right:5px;}
    #transferTokens {width: 200px; margin-right:5px; text-align:right;}
    #burnTokens {width: 200px; margin-right:5px; text-align:right;}
  </style>
</head>
<body>
<h3>PlayT ERC20토큰 테스트 <button onClick="window.location.reload()">새로고침</button></h3>
<div>     < 크롬/메타마스크 로그인후 사용하세요 ></div>
<ul>
  <li>토큰주소 =====> <span id="contractAddr"></span>
      </li>
    <input id="newContAddr" type="text"> 으로 
    <button onClick="changeContAddr()">토큰변경</button> </li>
    <div> 1. PLA  (exam-1) : 0x1d53CB190858F49cA1A75592Ed48a87f6EF4BC70</div>
    <div> 2. PLA  (exam-2) : 0x6C4351A83dE549951B98BB544630C2a8e0A9967C</div>
    <div> 3. KDJ9 (exam-3) : 0x83888D754BCA41Aed20197fCCb1359e10e4f2db0</div>
    <br>
  <li>토큰명(심볼) ==> <span id="name"></span>(<span id="symbol"></span>)</li>
  <li>소숫점자리수 ==> <span id="decimals"></span></li>
  <li>총발행량 =====> <span id="totalSupply"></span>
      (현재블록: <span id="lastBlock" ></span>)</li>
  <li>내 어카운트 ===> <span id="accountAddr"></span></li>
  <li>내 잔액 ======> <span id="balanceOf"></span></li>
  <li>토큰전송 =====> <input id="toAccount" type="text"> 에게 <input id="transferTokens" type="text"> 토큰 </span> <button onclick="transferToken()">보내기</button>
      <div id="resultTransfer"></div></li>
  <li>토큰소각 =====> <input id="burnTokens" type="text"> 토큰  <button onclick="burnToken()">없애기</button>
      <div id="resultBurn"></div></li>
  <li>토큰위임 =====> </li>
  <li>위임현황 =====> </li>
  <li>위임전송 =====> </li>
  <li>위임소각 =====> </li>
  <li>토큰관리자 ============> <span id="owner"></span></li>
  <li>관리자변경(관리자전용) ==> </li>
  <li>다음 관리자는 ==========> <span id="newOwner"></span></li>
  <li>권한받을 관리자 승인 ====> </li>
  <span style="color:red" id="historyProgress"></span><button onclick="contHistoryRopsten()"> 최근거래내역(Ropsten) </button>  
        <button onclick="contHistoryMain()"> 최근거래내역(Main) </button>
  <div id="historyResult"></div>
</ul>

</body>
<script src="https://cdn.rawgit.com/ethereum/web3.js/develop/dist/web3.js"></script>
<!-- script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script -->
<script>
var contractAddress = '0x83888D754BCA41Aed20197fCCb1359e10e4f2db0';
var abi = [
	{
		"constant": true,
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "spender",
				"type": "address"
			},
			{
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "totalSupply",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "from",
				"type": "address"
			},
			{
				"name": "to",
				"type": "address"
			},
			{
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "decimals",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "burn",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "tokenOwner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"name": "balance",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "acceptOwnership",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "from",
				"type": "address"
			},
			{
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "burnFrom",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "to",
				"type": "address"
			},
			{
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "spender",
				"type": "address"
			},
			{
				"name": "tokens",
				"type": "uint256"
			},
			{
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "approveAndCall",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "newOwner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "tokenAddress",
				"type": "address"
			},
			{
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "transferAnyERC20Token",
		"outputs": [
			{
				"name": "success",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "tokenOwner",
				"type": "address"
			},
			{
				"name": "spender",
				"type": "address"
			}
		],
		"name": "allowance",
		"outputs": [
			{
				"name": "remaining",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "from",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "Burn",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "_from",
				"type": "address"
			},
			{
				"indexed": true,
				"name": "_to",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "tokenOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"name": "spender",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "tokens",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	}
];
var PLATokenContract;
var PLAToken;
var cDecimals;
var accountAddress;
window.addEventListener('load', function() {
  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
    window.web3 = new Web3(web3.currentProvider);
  } else {
    console.log('No web3? You should consider trying MetaMask!')
    // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
    window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }
  // Now you can start your app & access web3 freely:
  startApp();
});
function startApp() {
  var MyAddress;
  PLATokenContract = web3.eth.contract(abi);
  PLAToken = PLATokenContract.at(contractAddress);
  document.getElementById('contractAddr').innerHTML = contractAddress + "  ☞  " + getLink(contractAddress);
  web3.eth.getAccounts(function(e,r){
    document.getElementById('accountAddr').innerHTML = r[0] + "  ☞  " + getLink(r[0]);
    accountAddress = r;
    getValue();
  });
}

function getLink(addr) {
  return '<a target="_blank" href=https://ropsten.etherscan.io/address/' + addr + '>' + "상세보기(RopstenTestNet)" +'</a>' + "     " +
         "  ☞  " + '<a target="_blank" href=https://etherscan.io/address/' + addr + '>' + "상세보기(MainNet)" +'</a>';
}

function getLinkTx(addr,tx) {
  return '<a target="_blank" href=https://ropsten.etherscan.io/tx/' + tx + '>' + addr +'</a>';
}

function changeContAddr() {
  // newAccAddr validation required..
  contractAddress = document.getElementById('newContAddr').value;
  startApp();
}
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        callback(null, xhr.response);
      } else {
        callback(status);
      }
    };
    xhr.send();
};
function contHistoryRopsten() {
    
  var resultArea = document.getElementById('historyResult');
  var resultText = "";
    
  document.getElementById('historyProgress').innerHTML="<i>seaching txs  </i>";
  getJSON('https://ropsten.etherscan.io/api?module=account&action=txlist&address='
	+ contractAddress +
	'&startblock=0&endblock=99999999&sort=asc&apikey=YourApiKeyToken',
	function(err, data) {
	  if (err != null) { //error on querying
	  } else {
	    var count = data.result.length;
		var result = data.result;
		
		console.log(data);
		
		resultText += "total "+count+" txs found <br>";
		
		for (var i = count-1; i >= count-10; i--) {
		  
		  if (i<0) break;
		  var option = document.createElement("option");
		  option.text = result[i].blockNumber;
		  console.log(result[i]);
		  resultText += '<a target="_blank" href=https://ropsten.etherscan.io/tx/'+result[i].hash+'>'+
                                        "block:"+result[i].blockNumber+
		  			" / TXhash:"+result[i].hash+'</a>'+'<br>';
		}
		
		console.log(resultText);
		
		
		document.getElementById('historyResult').innerHTML=resultText;
	  
	  }
 	
	document.getElementById('historyProgress').innerHTML="";
	}
  );

}

function contHistoryMain() {
    
  var resultArea = document.getElementById('historyResult');
  var resultText = "";
    
  document.getElementById('historyProgress').innerHTML="<i>seaching txs  </i>";
  getJSON('https://etherscan.io/api?module=account&action=txlist&address='
	+ contractAddress +
	'&startblock=0&endblock=99999999&sort=asc&apikey=YourApiKeyToken',
	function(err, data) {
	  if (err != null) { //error on querying
	  } else {
	    var count = data.result.length;
		var result = data.result;
		
		console.log(data);
		
		resultText += "total "+count+" txs found <br>";
		
		for (var i = count-1; i >= count-10; i--) {
		  
		  if (i<0) break;
		  var option = document.createElement("option");
		  option.text = result[i].blockNumber;
		  console.log(result[i]);
		  resultText += '<a target="_blank" href=https://etherscan.io/tx/'+result[i].hash+'>'+
                                        "block:"+result[i].blockNumber+
		  			" / TXhash:"+result[i].hash+'</a>'+'<br>';
		}
		
		console.log(resultText);
		
		
		document.getElementById('historyResult').innerHTML=resultText;
	  
	  }
 	
	document.getElementById('historyProgress').innerHTML="";
	}
  );

}


function getValue() {
  var tempVar1;
  var tempVar2;
  PLAToken.name(function(e,r){
    document.getElementById('name').innerHTML=r;
  });
  PLAToken.symbol(function(e,r){
    document.getElementById('symbol').innerHTML=r;
  });
  PLAToken.decimals(function(e,r){
    document.getElementById('decimals').innerHTML=r;
    cDecimals = r;
  });
  PLAToken.totalSupply(function(e,r){
    document.getElementById('totalSupply').innerHTML=r.toFixed(18)/10**cDecimals;
  });
  web3.eth.getBlockNumber(function(e,r){
    document.getElementById('lastBlock').innerHTML = r;
  });
  PLAToken.balanceOf(accountAddress,function(e,r){
    //tempVar1 = r.toString();
    //tempVar2 = tempVar1.substring(1,tempVar1.length-cDecimals) + '.' + tempVar1.substring(tempVar1.length-cDecimals+1,tempVar1.length);
    tempVar1 = r.toFixed(cDecimals)/10**cDecimals;
    document.getElementById('balanceOf').innerHTML=tempVar1.toFixed(cDecimals);
  });
  PLAToken.owner(function(e,r){
    document.getElementById('owner').innerHTML=r;
  });
  PLAToken.newOwner(function(e,r){
    document.getElementById('newOwner').innerHTML=r;
  });
}

function transferToken() {
  var toAccount = document.getElementById('toAccount').value;
  var transferTokens = document.getElementById('transferTokens').value;
  var txid
  PLAToken.transfer(toAccount, transferTokens*10**cDecimals, function(e,r){
    document.getElementById('resultTransfer').innerHTML = 'Transaction id: ' + r + '<span id="pending" style="color:red;">(Pending)</span>';
    txid = r;
  });
  var filter = web3.eth.filter('latest');
  filter.watch(function(e, r) {
    getValue();
    web3.eth.getTransaction(txid, function(e,r){
      if (r != null && r.blockNumber > 0) {
        document.getElementById('pending').innerHTML = '(기록된 블록: ' + r.blockNumber + ')';
        document.getElementById('pending').style.cssText ='color:green;';
        document.getElementById('toAccount').style.cssText ='color:green;';
        document.getElementById('transferTokens').style.cssText ='color:green;';
        filter.stopWatching();
      }
   });
 });
}

function burnToken() {
  var burnTokens = document.getElementById('burnTokens').value;
  var txid
  PLAToken.burn(burnTokens*10**cDecimals, function(e,r){
    document.getElementById('resultBurn').innerHTML = 'Transaction id: ' + r + '<span id="pending" style="color:red;">(Pending)</span>';
    txid = r;
  });
  var filter = web3.eth.filter('latest');
  filter.watch(function(e, r) {
    getValue();
    web3.eth.getTransaction(txid, function(e,r){
      if (r != null && r.blockNumber > 0) {
        document.getElementById('pending').innerHTML = '(기록된 블록: ' + r.blockNumber + ')';
        document.getElementById('pending').style.cssText ='color:green;';
        document.getElementById('burnTokens').style.cssText ='color:green;';
        filter.stopWatching();
      }
   });
 });
}
</script>
</html>
